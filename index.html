<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8" />
 <title>ShowCase</title>
 <style>
  html, body { width: 100%; height: 100%; margin: 0; overflow: hidden; }
  #renderCanvas { width: 100%; height: 100%; touch-action: none; }
 </style>

  <script src="https://cdn.babylonjs.com/babylon.js"></script>
 <script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.min.js"></script>
 <script src="https://cdn.babylonjs.com/ammo.js"></script>

  <script src="js/physics.js"></script>
 <script src="js/interactions.js"></script>
</head>

<body>
 <canvas id="renderCanvas"></canvas>
 <script>
  const canvas = document.getElementById("renderCanvas");
  const engine = new BABYLON.Engine(canvas, true);

  // ================================
  // Fungsi utama: Membuat Scene
  // ================================
  const createScene = async function () {
   const scene = new BABYLON.Scene(engine);
   scene.clearColor = new BABYLON.Color3(0.9, 0.9, 0.95);

   // Aktifkan sistem fisika dari file physics.js
   await enablePhysics(scene);

   // ================================
   // Buat ground (lantai dunia)
   // ================================
   const ground = BABYLON.MeshBuilder.CreateGround("ground", { width: 100, height: 100 }, scene);
   ground.checkCollisions = true;
   ground.position.y = 0;
   ground.physicsImpostor = new BABYLON.PhysicsImpostor(
    ground,
    BABYLON.PhysicsImpostor.BoxImpostor,
    { mass: 0, restitution: 0.9 },
    scene
   );

   // ================================
   // Cahaya dan Arah
   // ================================
   const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
   light.intensity = 0.7;
   const dirLight = new BABYLON.DirectionalLight("dirLight", new BABYLON.Vector3(-1, -2, -1), scene);
   dirLight.intensity = 1;

   // ================================
      // Kamera sebagai "Player" (POV manusia)
      // ================================
      const camera = new BABYLON.UniversalCamera("camera", new BABYLON.Vector3(-15, 2, 0), scene);
   camera.attachControl(canvas, true);
   camera.applyGravity = true;
   camera.ellipsoid = new BABYLON.Vector3(0.5, 1, 0.5);
   camera.checkCollisions = true;
   camera.speed = 0.2;
   camera.keysUp.push(87); camera.keysDown.push(83); camera.keysLeft.push(65); camera.keysRight.push(68); 

   let xr = null;

   // ================================
      // Tambahkan Model + Collision
      // ================================
      BABYLON.SceneLoader.ImportMeshAsync("", "assets/", "ruang_periksa.glb", scene 
   ).then((result) => {
     if (result.meshes.length > 0) {
       result.meshes[0].position = new BABYLON.Vector3(-22.5, 0, 8);
       result.meshes[0].scaling = new BABYLON.Vector3(-0.5, 0.5, 0.5);
       result.meshes[0].getChildMeshes().forEach(mesh => { 
         mesh.checkCollisions = true;
        });
     }
   }).catch((error) => { console.error("Gagal memuat model:", error); });


   // ================================
   // Aktifkan VR / XR Mode
   // ================================
      try {
     xr = await scene.createDefaultXRExperienceAsync({
      floorMeshes: [ground],
      disableTeleportation: true,
      cameraOptions:{
       checkCollisions: true,
       applyGravity: true,
       ellipsoid: new BABYLON.Vector3(0.5, 2, 0.5)
      }
     });
     console.log("✅ WebXR aktif");
     const xrCamera = xr.baseExperience.camera;
     xrCamera.position.y = 4;
     xrCamera.applyGravity = true;
     xrCamera.checkCollisions = true;

     xr.baseExperience.featuresManager.enableFeature(
      BABYLON.WebXRFeatureName.MOVEMENT,
      "latest",
      {
       xrInput: xr.input,
       movementSpeed: 0.1,
       rotationSpeed: 0.2,
       movementControls: ["left-xr-standard-thumbstick"],
       rotationControls: ["right-xr-standard-thumbstick"],
       useThumbstickForMovement: true,
       disableTeleportOnThumbstick: true,
       checkCollisions: true,
       applyGravity: true,
       ellipsoid: new BABYLON.Vector3(0.5, 2, 0.5)
      }
     );
   } catch (e) {
     console.warn("⚠️ WebXR tidak didukung, pakai mode biasa:", e);
     scene.activeCamera = camera;
     camera.applyGravity = true;
     camera.checkCollisions = true;
   }
      if (xr) {
        console.log("WebXR state: ", xr.baseExperience.state);
      }
   console.log("Current Camera: ", scene.activeCamera.name);
  

      // ===================================================
      // [PERBAIKAN TOTAL] Muat GLB dengan "Wrapper" Fisika
      // ===================================================

      // Tentukan ukuran box fisika (sesuaikan jika perlu)
      const itemPhysicsSize = 0.2; // 20cm
      const itemPhysicsMass = 0.01; // Massa ringan
      const startY = 2.0; // Ketinggian awal item

      /**
       * Fungsi Helper untuk memuat item grabbable dengan wrapper fisika
       */
      function createGrabbableItem(name, glbFile, position, scaling, rotation) {
          // 1. Buat Wrapper Box (yang akan kena fisika)
          const wrapper = BABYLON.MeshBuilder.CreateBox(name + "Wrapper", {
              size: itemPhysicsSize // Ukuran box fisika
          }, scene);
          wrapper.position = position; // Posisi di dunia
          wrapper.isVisible = false; // Sembunyikan box fisika

          // 2. Tambahkan metadata ke WRAPPER
          wrapper.metadata = {
              isGrabbable: true,
              itemData: { title: name }
          };

          // 3. Tambahkan fisika ke WRAPPER
          wrapper.physicsImpostor = new BABYLON.PhysicsImpostor(
              wrapper,
              BABYLON.PhysicsImpostor.BoxImpostor,
              { mass: itemPhysicsMass, restitution: 0.4 },
              scene
          );

          // 4. Muat model GLB
          BABYLON.SceneLoader.ImportMesh("", "assets/", glbFile, scene, function (meshes) {
           const rootMesh = meshes[0];
          
            // 5. Parent-kan GLB ke WRAPPER
           rootMesh.setParent(wrapper);
          
            // 6. Atur posisi/skala/rotasi GLB RELATIF ke wrapper
           rootMesh.position = new BABYLON.Vector3(0, 0, 0); // Selalu (0,0,0) relatif ke parent
           rootMesh.scaling = scaling;
              if (rotation) {
                  rootMesh.rotation = rotation;
              }
          });
      }

      // --- Gunakan helper untuk memuat semua item ---

      createGrabbableItem("Perban", "perban.glb", 
          new BABYLON.Vector3(-17, startY, 7.8), 
          new BABYLON.Vector3(0.03, 0.03, 0.03)
      );

      createGrabbableItem("Oximeter", "oximeter.glb", 
          new BABYLON.Vector3(-17, startY, 9.7), 
          new BABYLON.Vector3(0.13, 0.13, 0.13)
      );

      createGrabbableItem("Gunting Medis", "gunting medis.glb", 
          new BABYLON.Vector3(-17, startY, 11.7), 
          new BABYLON.Vector3(0.015, 0.015, 0.015)
      );

      createGrabbableItem("Reflex Hammer", "reflex hammer.glb", 
          new BABYLON.Vector3(-17, startY, 13.8), 
          new BABYLON.Vector3(3, 3, 3)
      );
      
      createGrabbableItem("Stethoscope", "stethoscope.glb", 
          new BABYLON.Vector3(-17, startY, 15.6), 
          new BABYLON.Vector3(0.0015, 0.0015, 0.0015)
      );

      createGrabbableItem("Kasa", "kasa.glb", 
          new BABYLON.Vector3(-13, startY, 7.8), 
          new BABYLON.Vector3(5, 5, 5)
      );

      createGrabbableItem("Suntik", "suntik.glb", 
          new BABYLON.Vector3(-13, startY, 9.9), 
          new BABYLON.Vector3(0.001, 0.001, 0.001)
      );

      createGrabbableItem("Thermometer", "thermometer.glb", 
          new BABYLON.Vector3(-13, startY, 11.7), 
          new BABYLON.Vector3(0.25, 0.25, 0.25),
          new BABYLON.Vector3(80, 160, 0) // Rotasi
      );

      createGrabbableItem("Tensimeter", "tensimeter.glb", 
          new BABYLON.Vector3(-13, startY, 13.8), 
          new BABYLON.Vector3(0.3, 0.3, 0.3),
          new BABYLON.Vector3(-110, 160, 100) // Rotasi
      );

      // ===================================================
      // Item STATIS (Tidak bisa diambil) - Tetap sama
      // ===================================================
      BABYLON.SceneLoader.ImportMesh("", "assets/", "TIANG INFUS.glb", scene, function (meshes) {
       const rootMesh = meshes[0];
       rootMesh.position = new BABYLON.Vector3(-11, 0.1, 5.4);
       rootMesh.scaling = new BABYLON.Vector3(0.04, 0.04, 0.04);
       rootMesh.physicsImpostor = new BABYLON.PhysicsImpostor(
          rootMesh,
          BABYLON.PhysicsImpostor.BoxImpostor, 
          { mass: 0, restitution: 0.4 }, // massa 0 = statis
          scene
        );
      });

      // ===================================================
      // Meja Kolisi (Tetap sama)
      // ===================================================
      const mejaCollision1= BABYLON.MeshBuilder.CreateBox("mejaCollision", {height: 1.6, width: 0.7, depth: 10}, scene);
      mejaCollision1.position = new BABYLON.Vector3(-17, 0.5, 12);
      mejaCollision1.isVisible = false; 
      mejaCollision1.physicsImpostor = new BABYLON.PhysicsImpostor(
        mejaCollision1, BABYLON.PhysicsImpostor.BoxImpostor, 
        { mass: 0, restitution: 0.2 }, scene
      );
      
      const mejaCollision2= BABYLON.MeshBuilder.CreateBox("mejaCollision", {height: 1.6, width: 0.7, depth: 10}, scene);
      mejaCollision2.position = new BABYLON.Vector3(-13, 0.5, 12);
      mejaCollision2.isVisible = false;
      mejaCollision2.physicsImpostor = new BABYLON.PhysicsImpostor(
        mejaCollision2, BABYLON.PhysicsImpostor.BoxImpostor, 
        { mass: 0, restitution: 0.2 }, scene
      );

      // ===================================================
      // [PENTING] PANGGIL FUNGSI DARI GRAB.JS DI AKHIR
      // ===================================================
      setupVRInput(xr,scene);

      return scene;
  };
  
  // ================================
  // Jalankan Scene
  // ================================
  createScene().then(scene => {
   engine.runRenderLoop(() => scene.render());
  });

  // Resize otomatis saat jendela berubah
  window.addEventListener("resize", () => engine.resize());
 </script>
</body>
</html>
